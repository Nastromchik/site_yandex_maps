<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–∞—Ä—à—Ä—É—Ç —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º –∏ –¥–µ—Ç–∞–ª—è–º–∏</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
        
        #map { width: 100%; height: 100%; cursor: crosshair; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 360px; /* –ß—É—Ç—å —à–∏—Ä–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π */
            background: white;
            padding: 20px;
            z-index: 2000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* –ß—Ç–æ–±—ã –Ω–µ —É–ª–µ–∑–∞–ª–∞ –∑–∞ —ç–∫—Ä–∞–Ω */
        }

        .hint { font-size: 11px; color: #888; text-align: center; margin-bottom: 10px; }
        #clickStatus { font-size: 12px; color: #1e98ff; text-align: center; margin-bottom: 5px; height: 15px; }

        .input-container { position: relative; margin-bottom: 10px; }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—è */
        .active-field { border: 2px solid #1e98ff !important; background-color: #f0f8ff; }

        label { display: block; margin-bottom: 3px; color: #555; font-size: 12px; }

        input {
            width: 100%; padding: 10px; box-sizing: border-box;
            border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .modes-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            padding: 3px;
        }

        .mode-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 0;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px;
            transition: 0.2s;
            color: #555;
        }

        .mode-btn:hover { background: #e0e0e0; }

        .mode-btn.active {
            background: white;
            font-weight: bold;
            color: #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (Geocode) */
        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc; border-top: none;
            max-height: 200px; overflow-y: auto; z-index: 3000;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f0f8ff; }
        .suggestion-item strong { display: block; color: #000; }
        .suggestion-item span { color: #777; font-size: 11px; }

        button.main-btn {
            width: 100%; padding: 12px;
            background: #fc0; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 16px;
        }
        button.main-btn:hover { background: #f2c200; }

        /* –ë–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-details {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
            overflow-y: auto; /* –°–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –º–Ω–æ–≥–æ —à–∞–≥–æ–≤ */
            flex-grow: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
        }

        .route-summary { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .route-summary span { font-weight: normal; color: #666; font-size: 14px; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —à–∞–≥–æ–≤ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ */
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .step-icon {
            width: 24px; height: 24px;
            background: #eee; border-radius: 50%;
            text-align: center; line-height: 24px;
            margin-right: 10px; font-size: 14px; flex-shrink: 0;
        }
        .step-text { line-height: 1.4; color: #333; }
        .step-meta { color: #888; font-size: 11px; }
    </style>

    <!-- API –ö–ª—é—á -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=<api_here>&lang=ru_RU" type="text/javascript"></script>
</head>
<body>

    <div class="controls-panel">
        <h3 style="text-align:center; margin-top:0;">–ú–∞—Ä—à—Ä—É—Ç</h3>
        <p class="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (Enter)</p>
        <div id="clickStatus"></div>

        <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
        <div class="modes-container">
            <button class="mode-btn active" onclick="setMode('auto')" id="btn-auto">üöó –ê–≤—Ç–æ</button>
            <button class="mode-btn" onclick="setMode('masstransit')" id="btn-transit">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
            <button class="mode-btn" onclick="setMode('pedestrian')" id="btn-pedestrian">üö∂ –ü–µ—à–∫–æ–º</button>
        </div>
        
        <div class="input-container">
            <label>–û—Ç–∫—É–¥–∞:</label>
            <input type="text" id="startInput" class="active-field" placeholder="–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ..." autocomplete="off">
            <div id="startList" class="suggestions-list"></div>
        </div>
        
        <div class="input-container">
            <label>–ö—É–¥–∞:</label>
            <input type="text" id="endInput" placeholder="–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ..." autocomplete="off">
            <div id="endList" class="suggestions-list"></div>
        </div>

        <button class="main-btn" onclick="buildRoute()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
        
        <!-- –°—é–¥–∞ –±—É–¥–µ–º –≤—ã–≤–æ–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ -->
        <div id="routeDetails" class="route-details"></div>
    </div>

    <div id="map"></div>

    <script>
        var myMap;
        var multiRoute = null;
        var currentInputId = 'startInput';
        var currentMode = 'auto'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–≤—Ç–æ
        
        var strictMoscowBounds = [[55.489926, 37.319329], [56.009657, 37.945661]];

        ymaps.ready(init);

        function init() {
            myMap = new ymaps.Map('map', {
                center: [55.751574, 37.573856],
                zoom: 11,
                controls: ['zoomControl', 'fullscreenControl']
            });

            setupEnterSearch('startInput', 'startList');
            setupEnterSearch('endInput', 'endList');

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –ø–æ–ª–µ–π
            document.getElementById('startInput').addEventListener('focus', function() { setActiveField('startInput'); });
            document.getElementById('endInput').addEventListener('focus', function() { setActiveField('endInput'); });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');
                var statusDiv = document.getElementById('clickStatus');
                statusDiv.innerText = "–ò—â–µ–º –∞–¥—Ä–µ—Å...";

                ymaps.geocode(coords, { kind: 'house', results: 1 }).then(function (res) {
                    var obj = res.geoObjects.get(0);
                    if (obj) {
                        document.getElementById(currentInputId).value = obj.getAddressLine();
                        statusDiv.innerText = "";
                        if (currentInputId === 'startInput') setActiveField('endInput');
                    } else {
                        statusDiv.innerText = "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    }
                });
            });
        }

        function setActiveField(id) {
            currentInputId = id;
            document.getElementById('startInput').classList.remove('active-field');
            document.getElementById('endInput').classList.remove('active-field');
            document.getElementById(id).classList.add('active-field');
        }

        // --- –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ (–ê–≤—Ç–æ / –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç / –ü–µ—à–∫–æ–º) ---
        function setMode(mode) {
            currentMode = mode;
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'auto') document.getElementById('btn-auto').classList.add('active');
            if(mode === 'masstransit') document.getElementById('btn-transit').classList.add('active');
            if(mode === 'pedestrian') document.getElementById('btn-pedestrian').classList.add('active');

            // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å–∞ —É–∂–µ –≤–≤–µ–¥–µ–Ω—ã, —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º
            var start = document.getElementById('startInput').value;
            var end = document.getElementById('endInput').value;
            if (start && end) {
                buildRoute();
            }
        }

        function buildRoute() {
            var start = document.getElementById('startInput').value;
            var end = document.getElementById('endInput').value;
            var detailsDiv = document.getElementById('routeDetails');

            if (!start || !end) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞!");
                return;
            }

            if (multiRoute) myMap.geoObjects.remove(multiRoute);
            detailsDiv.innerHTML = "<i>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</i>";

            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º (currentMode)
            multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [start, end],
                params: {
                    routingMode: currentMode, // 'auto', 'masstransit', 'pedestrian'
                    boundedBy: strictMoscowBounds
                }
            }, {
                boundsAutoApply: true
            });

            myMap.geoObjects.add(multiRoute);

            // –ö–û–ì–î–ê –ú–ê–†–®–†–£–¢ –ù–ê–ô–î–ï–ù -> –†–ê–ó–ë–ò–†–ê–ï–ú –î–ï–¢–ê–õ–ò
            multiRoute.model.events.add('requestsuccess', function() {
                var activeRoute = multiRoute.getActiveRoute();
                if (!activeRoute) {
                    detailsDiv.innerHTML = "–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    return;
                }

                // –û–±—â–µ–µ –≤—Ä–µ–º—è –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                var duration = activeRoute.properties.get("duration").text;
                var distance = activeRoute.properties.get("distance").text;
                
                var html = `<div class="route-summary">${duration} <span>(${distance})</span></div>`;

                // –ï—Å–ª–∏ —ç—Ç–æ –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –≤—ã–≤–æ–¥–∏–º —à–∞–≥–∏
                if (currentMode === 'masstransit') {
                    var paths = activeRoute.getPaths();
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—É—Ç–∏
                    var path = paths.get(0); 
                    var segments = path.getSegments();

                    segments.each(function(segment) {
                        var type = segment.properties.get('type'); // 'walk', 'transport', 'transfer'
                        var text = "";
                        var icon = "";
                        var meta = "";

                        if (type === 'walk') {
                            icon = "üö∂";
                            text = "–ü–µ—à–∫–æ–º " + segment.properties.get("distance").text;
                            meta = segment.properties.get("duration").text;
                        } 
                        else if (type === 'transport') {
                            var transports = segment.properties.get('transports');
                            if (transports && transports.length > 0) {
                                var t = transports[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ê–≤—Ç–æ–±—É—Å 22)
                                icon = getTransportIcon(t.type);
                                text = t.name; // –ù–æ–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞
                                meta = segment.properties.get("stopsCount") + " –æ—Å—Ç. (" + segment.properties.get("duration").text + ")";
                            }
                        } 
                        else if (type === 'transfer') {
                            icon = "üîÑ";
                            text = "–ü–µ—Ä–µ—Å–∞–¥–∫–∞";
                            meta = segment.properties.get("duration").text;
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º —à–∞–≥ –≤ HTML
                        if (text) {
                            html += `
                            <div class="step-item">
                                <div class="step-icon">${icon}</div>
                                <div>
                                    <div class="step-text">${text}</div>
                                    <div class="step-meta">${meta}</div>
                                </div>
                            </div>`;
                        }
                    });
                } else if (currentMode === 'auto') {
                    // –î–ª—è –∞–≤—Ç–æ –ø–æ–∫–∞–∂–µ–º –ø—Ä–æ–±–∫–∏
                    var durationInTraffic = activeRoute.properties.get("durationInTraffic").text;
                    html += `<div style="font-size:13px; color:#555;">–° —É—á–µ—Ç–æ–º –ø—Ä–æ–±–æ–∫: <b>${durationInTraffic}</b></div>`;
                }

                detailsDiv.innerHTML = html;
            });

            multiRoute.model.events.add('requestfail', function(e) {
                detailsDiv.innerHTML = "<span style='color:red'>–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞</span>";
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        function getTransportIcon(type) {
            if (type === 'bus') return 'üöå';
            if (type === 'trolleybus') return 'üöé';
            if (type === 'tramway') return 'üöã';
            if (type === 'underground') return 'üöá'; // –ú–µ—Ç—Ä–æ
            if (type === 'railway') return 'üöÜ'; // –≠–ª–µ–∫—Ç—Ä–∏—á–∫–∞
            return 'üöå';
        }

        // --- (–°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø–æ–∏—Å–∫–∞ –ø–æ Enter) ---
        function setupEnterSearch(inputId, listId) {
            var input = document.getElementById(inputId);
            var list = document.getElementById(listId);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    var query = input.value;
                    if(query) searchAddressInMoscow(query, list, input);
                }
            });
            document.addEventListener('click', function(e) {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }
        function searchAddressInMoscow(userQuery, listElement, inputElement) {
            listElement.innerHTML = '<div style="padding:10px;">–ü–æ–∏—Å–∫...</div>';
            listElement.style.display = 'block';
            ymaps.geocode("–ú–æ—Å–∫–≤–∞, " + userQuery, { boundedBy: strictMoscowBounds, strictBounds: true, results: 5 })
            .then(function (res) {
                listElement.innerHTML = '';
                if (res.geoObjects.getLength() === 0) {
                    listElement.innerHTML = '<div style="padding:10px; color:red;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return;
                }
                res.geoObjects.each(function (obj) {
                    var item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = '<strong>' + obj.properties.get('name') + '</strong><span>' + obj.properties.get('description') + '</span>';
                    item.onclick = function() {
                        inputElement.value = obj.getAddressLine();
                        listElement.style.display = 'none';
                    };
                    listElement.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>