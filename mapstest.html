<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–∞—Ä—à—Ä—É—Ç + –ë–∞–∑–∞ –º–µ—Ç–æ–∫</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
        
        #map { width: 100%; height: 100%; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 360px;
            background: white;
            padding: 20px;
            z-index: 2000;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .hint { font-size: 11px; color: #888; text-align: center; margin-bottom: 10px; }
        #clickStatus { font-size: 12px; color: #1e98ff; text-align: center; margin-bottom: 5px; height: 15px; font-weight: bold;}

        .input-container { position: relative; margin-bottom: 10px; }
        .active-field { border: 2px solid #1e98ff !important; background-color: #f0f8ff; }
        label { display: block; margin-bottom: 3px; color: #555; font-size: 12px; }
        input {
            width: 100%; padding: 10px; box-sizing: border-box;
            border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .modes-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            padding: 3px;
        }

        .mode-btn {
            flex: 1; border: none; background: transparent; padding: 8px 0;
            cursor: pointer; font-size: 13px; border-radius: 4px; transition: 0.2s; color: #555;
        }
        .mode-btn:hover { background: #e0e0e0; }
        .mode-btn.active { background: white; font-weight: bold; color: #000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞–º–∏ */
        .places-controls {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .secondary-btn {
            flex: 1; padding: 8px; font-size: 12px; cursor: pointer;
            border: 1px solid #ccc; background: #fff; border-radius: 4px;
        }
        .secondary-btn:hover { background: #f9f9f9; }
        .btn-active { background: #d4edda; border-color: #28a745; color: #155724; }

        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc; border-top: none;
            max-height: 200px; overflow-y: auto; z-index: 3000;
            display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f0f8ff; }
        .suggestion-item strong { display: block; color: #000; }
        .suggestion-item span { color: #777; font-size: 11px; }

        button.main-btn {
            width: 100%; padding: 12px;
            background: #fc0; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 5px;
        }
        button.main-btn:hover { background: #f2c200; }

        .route-details {
            margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;
            overflow-y: auto; flex-grow: 1;
        }
        .route-summary { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .step-item { display: flex; align-items: flex-start; margin-bottom: 10px; font-size: 13px; }
        .step-icon { width: 24px; height: 24px; background: #eee; border-radius: 50%; text-align: center; line-height: 24px; margin-right: 10px; flex-shrink: 0; }
    </style>

    <!-- API –ö–ª—é—á -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=<api_>&lang=ru_RU" type="text/javascript"></script>
</head>
<body>

    <div class="controls-panel">
        <h3 style="text-align:center; margin-top:0;">–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä</h3>
        <div id="clickStatus"></div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞–º–∏ -->
        <div class="places-controls">
            <button class="secondary-btn" id="btnAddPlace" onclick="toggleAddPlaceMode()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ</button>
            <button class="secondary-btn" onclick="routeToNearest()">üìç –ö –±–ª–∏–∂–∞–π—à–µ–º—É</button>
        </div>

        <div class="modes-container">
            <button class="mode-btn active" onclick="setMode('auto')" id="btn-auto">üöó –ê–≤—Ç–æ</button>
            <button class="mode-btn" onclick="setMode('masstransit')" id="btn-transit">üöå –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</button>
            <button class="mode-btn" onclick="setMode('pedestrian')" id="btn-pedestrian">üö∂ –ü–µ—à–∫–æ–º</button>
        </div>
        
        <div class="input-container">
            <label>–û—Ç–∫—É–¥–∞:</label>
            <input type="text" id="startInput" class="active-field" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫..." autocomplete="off">
            <div id="startList" class="suggestions-list"></div>
        </div>
        
        <div class="input-container">
            <label>–ö—É–¥–∞:</label>
            <input type="text" id="endInput" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫..." autocomplete="off">
            <div id="endList" class="suggestions-list"></div>
        </div>

        <button class="main-btn" onclick="buildRoute()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        
        <div id="routeDetails" class="route-details"></div>
    </div>

    <div id="map"></div>

    <script>
        var myMap;
        var multiRoute = null;
        var currentInputId = 'startInput';
        var currentMode = 'auto';
        var strictMoscowBounds = [[55.489926, 37.319329], [56.009657, 37.945661]];

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ú–ï–¢–û–ö ===
        var savedPlaces = []; // –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {coords: [], address: ""}
        var isAddingPlaceMode = false; // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

        ymaps.ready(init);

        function init() {
            myMap = new ymaps.Map('map', {
                center: [55.751574, 37.573856],
                zoom: 11,
                controls: ['zoomControl', 'fullscreenControl']
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
            loadPlacesFromStorage();

            setupEnterSearch('startInput', 'startList');
            setupEnterSearch('endInput', 'endList');

            document.getElementById('startInput').addEventListener('focus', function() { setActiveField('startInput'); });
            document.getElementById('endInput').addEventListener('focus', function() { setActiveField('endInput'); });

            // --- –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–ê –ü–û –ö–ê–†–¢–ï ---
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');
                var statusDiv = document.getElementById('clickStatus');

                // 1. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–∞
                if (isAddingPlaceMode) {
                    statusDiv.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Å—Ç–∞...";
                    ymaps.geocode(coords).then(function (res) {
                        var obj = res.geoObjects.get(0);
                        var address = obj ? obj.getAddressLine() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ";
                        
                        saveNewPlace(coords, address); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
                        toggleAddPlaceMode(); // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
                        statusDiv.innerText = "–ú–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
                        setTimeout(() => statusDiv.innerText = "", 2000);
                    });
                    return;
                }

                // 2. –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (–≤—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞)
                statusDiv.innerText = "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...";
                ymaps.geocode(coords, { kind: 'house', results: 1 }).then(function (res) {
                    var obj = res.geoObjects.get(0);
                    if (obj) {
                        document.getElementById(currentInputId).value = obj.getAddressLine();
                        statusDiv.innerText = "";
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ñ–æ–∫—É—Å
                        if (currentInputId === 'startInput') setActiveField('endInput');
                    } else {
                        statusDiv.innerText = "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    }
                });
            });
        }

        // === –õ–û–ì–ò–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• (LOCAL STORAGE) ===
        
        function loadPlacesFromStorage() {
            var stored = localStorage.getItem('myMapPlaces');
            if (stored) {
                savedPlaces = JSON.parse(stored);
                savedPlaces.forEach(place => {
                    renderPlaceMarker(place);
                });
            }
        }

        function saveNewPlace(coords, address) {
            var place = {
                id: Date.now(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                coords: coords,
                address: address
            };
            savedPlaces.push(place);
            localStorage.setItem('myMapPlaces', JSON.stringify(savedPlaces));
            renderPlaceMarker(place);
        }

        function deletePlace(id) {
            savedPlaces = savedPlaces.filter(p => p.id !== id);
            localStorage.setItem('myMapPlaces', JSON.stringify(savedPlaces));
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±: —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ, 
            // –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —É–¥–∞–ª–∏–º –æ–±—ä–µ–∫—Ç. 
            // –ó–¥–µ—Å—å –æ—á–∏—Å—Ç–∏–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º).
            myMap.geoObjects.removeAll();
            if (multiRoute) myMap.geoObjects.add(multiRoute); // –í–µ—Ä–Ω–µ–º –º–∞—Ä—à—Ä—É—Ç, –µ—Å–ª–∏ –±—ã–ª
            savedPlaces.forEach(renderPlaceMarker);
        }

        function renderPlaceMarker(place) {
            var placemark = new ymaps.Placemark(place.coords, {
                balloonContentHeader: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ",
                balloonContentBody: `<b>${place.address}</b><br><br><button onclick="deletePlace(${place.id})" style="color:red; cursor:pointer">–£–¥–∞–ª–∏—Ç—å</button>`,
                hintContent: "–í–∞—à–∞ –º–µ—Ç–∫–∞"
            }, {
                preset: 'islands#greenDotIcon'
            });

            myMap.geoObjects.add(placemark);
        }

        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò ===

        function toggleAddPlaceMode() {
            isAddingPlaceMode = !isAddingPlaceMode;
            var btn = document.getElementById('btnAddPlace');
            var status = document.getElementById('clickStatus');

            if (isAddingPlaceMode) {
                btn.classList.add('btn-active');
                btn.innerText = "‚ùå –û—Ç–º–µ–Ω–∞";
                status.innerText = "–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –º–µ—Ç–∫—É";
                myMap.cursors.push('crosshair');
            } else {
                btn.classList.remove('btn-active');
                btn.innerText = "‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–æ";
                status.innerText = "";
                myMap.cursors.push('arrow');
            }
        }

        // === –ü–û–ò–°–ö –ë–õ–ò–ñ–ê–ô–®–ï–ì–û ===

        function routeToNearest() {
            var startAddr = document.getElementById('startInput').value;
            var status = document.getElementById('clickStatus');

            if (!startAddr) {
                alert("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Ç–æ—á–∫—É '–û—Ç–∫—É–¥–∞'!");
                return;
            }
            if (savedPlaces.length === 0) {
                alert("–£ –≤–∞—Å –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç.");
                return;
            }

            status.innerText = "–ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π —Ç–æ—á–∫–∏...";

            // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ —Å—Ç–∞—Ä—Ç–∞
            ymaps.geocode(startAddr).then(function(res) {
                var startObj = res.geoObjects.get(0);
                if (!startObj) {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å —Å—Ç–∞—Ä—Ç–∞");
                    return;
                }
                var startCoords = startObj.geometry.getCoordinates();

                // 2. –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–æ—á–∫—É
                var closestPlace = null;
                var minDistance = Infinity;

                savedPlaces.forEach(place => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—á–µ—Ç–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
                    var dist = ymaps.coordSystem.geo.distance(startCoords, place.coords);
                    if (dist < minDistance) {
                        minDistance = dist;
                        closestPlace = place;
                    }
                });

                // 3. –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
                if (closestPlace) {
                    status.innerText = "–ú–∞—Ä—à—Ä—É—Ç –∫: " + closestPlace.address;
                    document.getElementById('endInput').value = closestPlace.address;
                    buildRoute();
                }
            });
        }

        // === –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –§–£–ù–ö–¶–ò–ò (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞) ===

        function setActiveField(id) {
            currentInputId = id;
            document.getElementById('startInput').classList.remove('active-field');
            document.getElementById('endInput').classList.remove('active-field');
            document.getElementById(id).classList.add('active-field');
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'auto') document.getElementById('btn-auto').classList.add('active');
            if(mode === 'masstransit') document.getElementById('btn-transit').classList.add('active');
            if(mode === 'pedestrian') document.getElementById('btn-pedestrian').classList.add('active');

            var start = document.getElementById('startInput').value;
            var end = document.getElementById('endInput').value;
            if (start && end) buildRoute();
        }

        function buildRoute() {
            var start = document.getElementById('startInput').value;
            var end = document.getElementById('endInput').value;
            var detailsDiv = document.getElementById('routeDetails');

            if (!start || !end) {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞!");
                return;
            }

            if (multiRoute) myMap.geoObjects.remove(multiRoute);
            detailsDiv.innerHTML = "<i>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</i>";

            multiRoute = new ymaps.multiRouter.MultiRoute({
                referencePoints: [start, end],
                params: { routingMode: currentMode, boundedBy: strictMoscowBounds }
            }, { boundsAutoApply: true });

            myMap.geoObjects.add(multiRoute);

            multiRoute.model.events.add('requestsuccess', function() {
                var activeRoute = multiRoute.getActiveRoute();
                if (!activeRoute) { detailsDiv.innerHTML = "–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"; return; }

                var duration = activeRoute.properties.get("duration").text;
                var distance = activeRoute.properties.get("distance").text;
                var html = `<div class="route-summary">${duration} <span>(${distance})</span></div>`;

                if (currentMode === 'masstransit') {
                    var paths = activeRoute.getPaths();
                    var segments = paths.get(0).getSegments();
                    segments.each(function(segment) {
                        var type = segment.properties.get('type');
                        var text = "", icon = "", meta = "";

                        if (type === 'walk') {
                            icon = "üö∂"; text = "–ü–µ—à–∫–æ–º " + segment.properties.get("distance").text;
                            meta = segment.properties.get("duration").text;
                        } 
                        else if (type === 'transport') {
                            var transports = segment.properties.get('transports');
                            if (transports && transports.length > 0) {
                                var t = transports[0];
                                icon = getTransportIcon(t.type); text = t.name;
                                meta = segment.properties.get("stopsCount") + " –æ—Å—Ç.";
                            }
                        } 
                        else if (type === 'transfer') { icon = "üîÑ"; text = "–ü–µ—Ä–µ—Å–∞–¥–∫–∞"; meta = segment.properties.get("duration").text; }

                        if (text) html += `<div class="step-item"><div class="step-icon">${icon}</div><div><div class="step-text">${text}</div><div class="step-meta">${meta}</div></div></div>`;
                    });
                } else if (currentMode === 'auto') {
                    var traffic = activeRoute.properties.get("durationInTraffic").text;
                    html += `<div style="font-size:13px; color:#555;">–° –ø—Ä–æ–±–∫–∞–º–∏: <b>${traffic}</b></div>`;
                }
                detailsDiv.innerHTML = html;
            });

            multiRoute.model.events.add('requestfail', function() {
                detailsDiv.innerHTML = "<span style='color:red'>–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è</span>";
            });
        }

        function getTransportIcon(type) {
            if (type === 'bus') return 'üöå';
            if (type === 'trolleybus') return 'üöé';
            if (type === 'tramway') return 'üöã';
            if (type === 'underground') return 'üöá';
            if (type === 'railway') return 'üöÜ';
            return 'üöå';
        }

        function setupEnterSearch(inputId, listId) {
            var input = document.getElementById(inputId);
            var list = document.getElementById(listId);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    var query = input.value;
                    if(query) searchAddressInMoscow(query, list, input);
                }
            });
            document.addEventListener('click', function(e) {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }

        function searchAddressInMoscow(userQuery, listElement, inputElement) {
            listElement.innerHTML = '<div style="padding:10px;">–ü–æ–∏—Å–∫...</div>';
            listElement.style.display = 'block';
            ymaps.geocode("–ú–æ—Å–∫–≤–∞, " + userQuery, { boundedBy: strictMoscowBounds, strictBounds: true, results: 5 })
            .then(function (res) {
                listElement.innerHTML = '';
                if (res.geoObjects.getLength() === 0) {
                    listElement.innerHTML = '<div style="padding:10px; color:red;">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return;
                }
                res.geoObjects.each(function (obj) {
                    var item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = '<strong>' + obj.properties.get('name') + '</strong><span>' + obj.properties.get('description') + '</span>';
                    item.onclick = function() {
                        inputElement.value = obj.getAddressLine();
                        listElement.style.display = 'none';
                    };
                    listElement.appendChild(item);
                });
            });
        }
    </script>
</body>
</html>